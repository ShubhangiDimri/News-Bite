<%- include('partials/header') %>

<nav
  style="
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--glass-border);
  "
>
  <a href="/" class="logo">
    <svg class="logo-icon"><use href="#logo-lightning"></use></svg>
    <span class="logo-text" style="font-size: 1.6rem;">NewsBite</span>
    <span
      style="
        font-size: 0.7rem;
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        padding: 0.1rem 0.4rem;
        border-radius: 1rem;
        border: 1px solid rgba(59, 130, 246, 0.3);
        margin-left: -0.2rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      "
      >Admin</span
    >
  </a>
  <div style="display: flex; align-items: center; gap: 1rem;">
    <!-- Theme Toggle — identical to navbar.ejs, handled by main.js -->
    <button class="theme-toggle" id="themeToggle" title="Toggle theme">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </button>
    <button
      onclick="handleLogout()"
      class="btn-primary"
      style="
        border: none;
        cursor: pointer;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 1rem;
      "
    >
      Logout
    </button>
  </div>
</nav>

<div class="container" style="margin-top: 3rem">
  <header class="feed-header">
    <h1
      style="
        font-size: 2.5rem;
        background: linear-gradient(to right, #3b82f6, #10b981);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      "
    >
      Admin Dashboard
    </h1>
    <p style="color: var(--text-muted); font-size: 1.1rem">
      Manage users and view platform statistics
    </p>
  </header>

  <!-- Statistics Cards -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    "
  >
    <div
      class="glass-panel"
      data-filter-type="all"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('all')"
      onmouseover="this.style.background='rgba(255,255,255,0.08)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Total Users
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: var(--text-main)">
        <%= stats.total %>
      </p>
    </div>
    <div
      class="glass-panel"
      data-filter-type="active"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('active')"
      onmouseover="this.style.background='rgba(16,185,129,0.1)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Active Users
      </h3>
      <p
        style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color)"
      >
        <%= stats.active %>
      </p>
    </div>
    <div
      class="glass-panel"
      data-filter-type="suspended"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('suspended')"
      onmouseover="this.style.background='rgba(239,68,68,0.1)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Suspended
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: #ef4444">
        <%= stats.suspended %>
      </p>
    </div>
    <div
      class="glass-panel"
      data-filter-type="admin"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('admin')"
      onmouseover="this.style.background='rgba(59,130,246,0.1)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Admins
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: #3b82f6">
        <%= stats.admins %>
      </p>
    </div>
  </div>

  <!-- Users Table -->
  <div
    class="glass-panel"
    style="padding: 2rem; border-radius: 1rem; margin-bottom: 4rem"
  >
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      "
    >
      <h2 style="font-size: 1.5rem; font-weight: 700">
        User Management
        <span
          id="filterBadge"
          style="
            display: none;
            margin-left: 1rem;
            font-size: 0.9rem;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.3);
          "
        ></span>
      </h2>
      <button
        id="clearFilter"
        style="
          display: none;
          padding: 0.5rem 1rem;
          background: rgba(239, 68, 68, 0.2);
          color: #ef4444;
          border: 1px solid rgba(239, 68, 68, 0.3);
          border-radius: 0.5rem;
          cursor: pointer;
          font-size: 0.9rem;
        "
        onclick="clearFilter()"
      >
        Clear Filter
      </button>
    </div>
    <div style="overflow-x: auto">
      <table style="width: 100%; border-collapse: collapse">
        <thead>
          <tr style="border-bottom: 1px solid var(--glass-border)">
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Username
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Role
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Status
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Joined
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Last Login
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Last Logout
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(u => { %>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05)">
            <td
              style="padding: 1rem; color: var(--text-main); font-weight: 500"
            >
              <%= u.username %>
            </td>
            <td style="padding: 1rem">
              <span
                style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; <%= u.role === 'admin' ? 'background: rgba(59, 130, 246, 0.2); color: #3b82f6;' : 'background: rgba(156, 163, 175, 0.2); color: var(--text-muted);' %>"
              >
                <%= u.role %>
              </span>
            </td>
            <td style="padding: 1rem">
              <span
                style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; <%= u.status === 'active' ? 'background: rgba(16, 185, 129, 0.2); color: var(--primary-color);' : u.status === 'suspended' ? 'background: rgba(239, 68, 68, 0.2); color: #ef4444;' : 'background: rgba(156, 163, 175, 0.2); color: var(--text-muted);' %>"
              >
                <%= u.status %>
              </span>
            </td>
            <td
              style="
                padding: 1rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              "
            >
              <%= new Date(u.createdAt).toLocaleDateString() %>
            </td>
            <td
              style="
                padding: 1rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              "
            >
              <%= u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() :
              'Never' %>
            </td>
            <td
              style="
                padding: 1rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              "
            >
              <%= u.lastLogout ? new Date(u.lastLogout).toLocaleDateString() :
              'Never' %>
            </td>
            <td style="padding: 1rem">
              <div style="display: flex; gap: 0.5rem">
                <button
                  onclick="viewActivity('<%= u.username %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #3b82f6;
                    color: #3b82f6;
                  "
                >
                  Activity
                </button>
                <% if (u.status === 'active' && u.role !== 'admin') { %>
                <button
                  onclick="suspendUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #ef4444;
                    color: #ef4444;
                  "
                >
                  Suspend
                </button>
                <% } else if (u.status === 'suspended') { %>
                <button
                  onclick="unsuspendUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: var(--primary-color);
                    color: var(--primary-color);
                  "
                >
                  Unsuspend
                </button>
                <% } %> <% if (u.role !== 'admin' && u._id.toString() !==
                user.userId) { %>
                <button
                  onclick="deleteUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #ef4444;
                    color: #ef4444;
                  "
                >
                  Delete
                </button>
                <% } %>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Registration Stats -->
  <div
    class="glass-panel"
    style="padding: 2rem; border-radius: 1rem; margin-bottom: 3rem"
  >
    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem">
      Registration Trends (Last 30 Days)
    </h2>
    <div style="height: 300px; width: 100%; position: relative;">
      <canvas id="registrationChart" style="width: 100%; height: 100%;"></canvas>
    </div>
  </div>
</div>

<script>
  // Store registration stats for chart initialization
  window.registrationStatsData = <%- JSON.stringify(registrationStats || []) %>;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<!-- Activity Modal -->
<div
  id="activityModal"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 100;
    align-items: center;
    justify-content: center;
  "
>
  <div
    class="glass-panel"
    style="
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      padding: 2rem;
      border-radius: 1.5rem;
    "
  >
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      "
    >
      <h3 id="modalTitle" style="font-size: 1.5rem; font-weight: 700">
        User Activity
      </h3>
      <button
        onclick="closeModal()"
        style="
          background: none;
          border: none;
          color: var(--text-muted);
          font-size: 1.5rem;
          cursor: pointer;
        "
      >
        &times;
      </button>
    </div>
    
    <!-- Activity Filters -->
    <div style="margin-bottom: 1.5rem; display: flex; flex-wrap: gap: 0.5rem; align-items: center; position: relative; z-index: 100;">
      <label style="font-size: 0.875rem; color: var(--text-muted); margin-right: 0.5rem;">Filter by:</label>
      <select id="categoryFilter" onchange="applyActivityFilter()" style="
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 0.5rem;
        padding: 0.25rem 0.75rem;
        color: #1f2937;
        font-size: 0.875rem;
        cursor: pointer;
        position: relative;
        z-index: 1000;
      ">
        <option value="" style="background: white; color: #1f2937;">All Categories</option>
        <option value="auth" style="background: white; color: #1f2937;">Authentication</option>
        <option value="news" style="background: white; color: #1f2937;">News Interactions</option>
        <option value="comments" style="background: white; color: #1f2937;">Comments</option>
        <option value="replies" style="background: white; color: #1f2937;">Replies</option>
        <option value="admin" style="background: white; color: #1f2937;">Admin Actions</option>
      </select>
      
      <select id="actionFilter" onchange="applyActivityFilter()" style="
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 0.5rem;
        padding: 0.25rem 0.75rem;
        color: #1f2937;
        font-size: 0.875rem;
        cursor: pointer;
        display: none;
        position: relative;
        z-index: 1000;
      ">
        <option value="">All Actions</option>
      </select>
      
      <button onclick="clearActivityFilters()" style="
        background: rgba(156, 163, 175, 0.1);
        border: 1px solid rgba(156, 163, 175, 0.2);
        border-radius: 0.5rem;
        padding: 0.25rem 0.75rem;
        color: var(--text-muted);
        font-size: 0.75rem;
        cursor: pointer;
        display: none;
      " id="clearActivityFilter">Clear</button>
      
      <div id="activityStats" style="
        margin-left: auto; 
        font-size: 0.8rem; 
        color: var(--text-muted); 
        background: rgba(255, 255, 255, 0.05);
        padding: 0.4rem 0.8rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        font-family: monospace;
        letter-spacing: 0.5px;
      "></div>
    </div>
    
    <div id="activityContent" style="overflow-y: auto; flex: 1">Loading...</div>
  </div>
</div>

<!-- Suspend User Modal -->
<div
  id="suspendModal"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 100;
    align-items: center;
    justify-content: center;
  "
>
  <div
    class="glass-panel"
    style="
      width: 90%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      padding: 2rem;
      border-radius: 1.5rem;
    "
  >
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      "
    >
      <h3 style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">
        Suspend User
      </h3>
      <button
        onclick="closeSuspendModal()"
        style="
          background: none;
          border: none;
          color: var(--text-muted);
          font-size: 1.5rem;
          cursor: pointer;
        "
      >
        &times;
      </button>
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <p style="color: var(--text-muted); margin-bottom: 1rem;">
        You are about to suspend user: <strong id="suspendUsername" style="color: var(--text-main);"></strong>
      </p>
      
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-main); font-weight: 600;">
          Reason for suspension (optional)
        </label>
        <textarea
          id="suspendReason"
          placeholder="Enter the reason for suspension (optional)..."
          style="
            width: 100%;
            min-height: 80px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: var(--text-main);
            font-size: 0.875rem;
            resize: vertical;
          "
        ></textarea>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-main); font-weight: 600;">
          Suspend until *
        </label>
        <input
          type="datetime-local"
          id="suspendUntil"
          style="
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: var(--text-main);
            font-size: 0.875rem;
          "
          required
        />
        <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem; display: block;">
          Set the date and time when the suspension should automatically end
        </small>
      </div>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button
        onclick="closeSuspendModal()"
        style="
          background: rgba(156, 163, 175, 0.1);
          border: 1px solid rgba(156, 163, 175, 0.2);
          border-radius: 0.5rem;
          padding: 0.75rem 1.5rem;
          color: var(--text-muted);
          cursor: pointer;
          font-size: 0.875rem;
        "
      >
        Cancel
      </button>
      <button
        onclick="confirmSuspension()"
        style="
          background: linear-gradient(45deg, #ef4444, #dc2626);
          border: none;
          border-radius: 0.5rem;
          padding: 0.75rem 1.5rem;
          color: white;
          cursor: pointer;
          font-size: 0.875rem;
          font-weight: 600;
        "
      >
        Suspend User
      </button>
    </div>
  </div>
</div>

<script>
  // Filter users by status or role
  function filterUsers(type) {
    const tableBody = document.querySelector('table tbody');
    const rows = tableBody.querySelectorAll('tr');
    let visibleCount = 0;
    const filterBadge = document.getElementById('filterBadge');
    const clearBtn = document.getElementById('clearFilter');
    const statCards = document.querySelectorAll('.glass-panel');

    // Remove active state from all cards
    document.querySelectorAll('[data-filter-type]').forEach(card => {
      card.style.opacity = '1';
      card.style.transform = 'scale(1)';
      card.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    });

    // Add active state to clicked card
    const activeCard = document.querySelector(`[data-filter-type="${type}"]`);
    if (activeCard) {
      activeCard.style.opacity = '1';
      activeCard.style.transform = 'scale(1.02)';
      activeCard.style.borderColor = '#3b82f6';
      activeCard.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
    }

    rows.forEach(row => {
      const statusCell = row.cells[2]; // Status column
      const roleCell = row.cells[1]; // Role column
      const status = statusCell.textContent.trim();
      const role = roleCell.textContent.trim();

      let shouldShow = false;
      let filterLabel = '';

      if (type === 'all') {
        shouldShow = true;
        filterLabel = '';
      } else if (type === 'active') {
        shouldShow = status === 'active';
        filterLabel = 'Active Users';
      } else if (type === 'suspended') {
        shouldShow = status === 'suspended';
        filterLabel = 'Suspended Users';
      } else if (type === 'admin') {
        shouldShow = role === 'admin';
        filterLabel = 'Admin Users';
      }

      row.style.display = shouldShow ? '' : 'none';
      if (shouldShow) visibleCount++;
    });

    // Update badge
    if (filterLabel) {
      filterBadge.textContent = filterLabel;
      filterBadge.style.display = 'inline-block';
      clearBtn.style.display = 'inline-block';
    } else {
      filterBadge.style.display = 'none';
      clearBtn.style.display = 'none';
    }

    // Show a message if no users match
    if (visibleCount === 0) {
      const emptyRow = document.createElement('tr');
      emptyRow.style.cssText = 'text-align: center;';
      emptyRow.innerHTML = `<td colspan="6" style="padding: 2rem; color: var(--text-muted);">No users found for this filter</td>`;
      tableBody.appendChild(emptyRow);
      setTimeout(() => emptyRow.remove(), 3000);
    }
  }

  // Clear filter and show all users
  function clearFilter() {
    const tableBody = document.querySelector('table tbody');
    const rows = tableBody.querySelectorAll('tr');

    rows.forEach(row => {
      row.style.display = '';
    });

    // Reset badge
    document.getElementById('filterBadge').style.display = 'none';
    document.getElementById('clearFilter').style.display = 'none';

    // Remove active state from all cards
    document.querySelectorAll('[data-filter-type]').forEach(card => {
      card.style.opacity = '1';
      card.style.transform = 'scale(1)';
      card.style.borderColor = 'rgba(255, 255, 255, 0.1)';
      card.style.boxShadow = 'none';
    });
  }

  // Initialize Chart.js
  let chartRetryCount = 0;
  function initializeChart() {
    const registrationStats = window.registrationStatsData || [];

    if (typeof Chart === 'undefined') {
      chartRetryCount++;
      if (chartRetryCount < 50) {
        console.error('Chart.js not loaded, retrying... (' + chartRetryCount + ')');
        setTimeout(initializeChart, 200);
      } else {
        console.error('Chart.js failed to load after 50 retries');
      }
      return;
    }

    console.log('Chart.js loaded successfully, initializing chart...');
    const canvas = document.getElementById('registrationChart');
    if (!canvas) {
      console.error('Chart canvas not found');
      return;
    }

    const ctx = canvas.getContext('2d');

    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

    new Chart(ctx, {
        type: 'line',
        data: {
          labels: registrationStats.map(s => {
            const date = new Date(s.date);
            return `${date.getDate()}/${date.getMonth() + 1}`;
          }),
          datasets: [{
            label: 'New Users',
            data: registrationStats.map(s => s.count),
            borderColor: '#3b82f6',
            backgroundColor: gradient,
            borderWidth: 2,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: '#9ca3af', stepSize: 1 }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#9ca3af' }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
  }

  // Initialize chart when page fully loads
  if (document.readyState === 'complete') {
    initializeChart();
  } else {
    window.addEventListener('load', initializeChart);
  }

  let currentSuspendUserId = null;

  async function suspendUser(userId) {
    currentSuspendUserId = userId;
    
    // Find the user's username from the table
    const userRow = document.querySelector(`button[onclick="suspendUser('${userId}')"]`).closest('tr');
    const username = userRow.cells[0].textContent.trim();
    
    document.getElementById('suspendUsername').textContent = username;
    document.getElementById('suspendReason').value = '';
    document.getElementById('suspendUntil').value = '';
    document.getElementById('suspendModal').style.display = 'flex';
  }

  function closeSuspendModal() {
    document.getElementById('suspendModal').style.display = 'none';
    currentSuspendUserId = null;
  }

  async function confirmSuspension() {
    const reason = document.getElementById('suspendReason').value.trim();
    const until = document.getElementById('suspendUntil').value;
    
    if (!until) {
      alert('Please select a suspension end date and time');
      return;
    }

    try {
      const requestBody = { until };
      if (reason) {
        requestBody.reason = reason;
      }

      const res = await fetch(`/api/admin/users/${currentSuspendUserId}/suspend`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestBody)
      });

      if (res.ok) {
        alert("User suspended successfully");
        closeSuspendModal();
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to suspend user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  async function unsuspendUser(userId) {
    try {
      const res = await fetch(`/api/admin/users/${userId}/unsuspend`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        alert("User unsuspended successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to unsuspend user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  async function deleteUser(userId) {
    if (
      !confirm(
        "Are you sure you want to delete this user? This action cannot be undone."
      )
    )
      return;

    try {
      const res = await fetch(`/api/admin/users/${userId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ confirm: true })
      });

      if (res.ok) {
        alert("User deleted successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to delete user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  function formatMeta(meta) {
    if (!meta || Object.keys(meta).length === 0) return '';

    let html = '<div style="display: grid; gap: 0.25rem; margin-top: 0.5rem; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 0.5rem;">';

    for (const [key, value] of Object.entries(meta)) {
      if (key === 'ip' || key === 'userAgent') continue;

      let displayValue = value;
      let displayKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');

      if (key === 'targetUsername') displayKey = 'Target User';
      if (key === 'targetId') displayKey = 'Target ID';

      html += `
        <div style="display: flex; gap: 0.5rem; font-size: 0.85rem;">
          <span style="color: var(--text-muted); min-width: 80px;">${displayKey}:</span>
          <span style="color: var(--text-main); word-break: break-all;">${displayValue}</span>
        </div>
      `;
    }

    html += '</div>';
    return html;
  }

  let currentUsername = '';
  let allActivities = [];
  let actionSummary = [];
  let categorySummary = [];

  async function viewActivity(username) {
    const modal = document.getElementById('activityModal');
    const title = document.getElementById('modalTitle');

    currentUsername = username;
    title.textContent = `Activity: ${username}`;
    clearActivityFilters();
    modal.style.display = 'flex';
    
    await loadActivity();
  }

  async function loadActivity(category = '', action = '') {
    const content = document.getElementById('activityContent');
    const stats = document.getElementById('activityStats');
    
    content.innerHTML = '<div style="display: flex; justify-content: center; padding: 2rem;"><div class="spinner"></div></div>';

    try {
      let url = `/api/admin/users/${currentUsername}/activity`;
      const params = new URLSearchParams();
      if (category) params.append('category', category);
      if (action) params.append('action', action);
      if (params.toString()) url += '?' + params.toString();

      const res = await fetch(url);
      const data = await res.json();

      if (res.ok) {
        allActivities = data.activities;
        actionSummary = data.actionSummary;
        categorySummary = data.categorySummary;
        
        updateActionFilter(category);
        updateStats(data.total, category || action);
        
        if (data.activities.length === 0) {
          content.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No activity found for the selected filter.</p>';
          return;
        }

        content.innerHTML = data.activities.map(act => `
          <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border); margin-bottom: 0.5rem; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
              <span style="font-weight: 600; color: var(--primary-color); font-family: monospace; background: rgba(59, 130, 246, 0.1); padding: 0.1rem 0.4rem; border-radius: 0.25rem;">${act.action}</span>
              <span style="font-size: 0.75rem; color: var(--text-muted);">${new Date(act.createdAt).toLocaleString()}</span>
            </div>
            ${formatMeta(act.meta)}
          </div>
        `).join('');
      } else {
        content.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${data.message}</p>`;
      }
    } catch (err) {
      console.error(err);
      content.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load activity.</p>';
    }
  }

  function updateActionFilter(selectedCategory) {
    const actionFilter = document.getElementById('actionFilter');
    const categoryActions = {
      'auth': ['auth.register', 'auth.login', 'auth.logout'],
      'news': ['news.like', 'news.bookmark'],
      'comments': ['comment.create', 'comment.delete', 'comment.vote'],
      'replies': ['reply.create', 'reply.delete', 'reply.vote'],
      'admin': ['admin.suspend', 'admin.unsuspend', 'admin.softDelete', 'admin.permanentDelete']
    };

    if (selectedCategory && categoryActions[selectedCategory]) {
      actionFilter.style.display = 'inline-block';
      actionFilter.innerHTML = '<option value="" style="background: white; color: #1f2937;">All Actions</option>' + 
        categoryActions[selectedCategory].map(action => 
          `<option value="${action}" style="background: white; color: #1f2937;">${action}</option>`
        ).join('');
    } else {
      actionFilter.style.display = 'none';
      actionFilter.value = '';
    }
  }

  function updateStats(total, filterType) {
    const stats = document.getElementById('activityStats');
    if (filterType) {
      stats.innerHTML = `<span style="color: #3b82f6; font-weight: 600;">${total}</span> activities found`;
    } else {
      const categoryText = categorySummary.map(cat => 
        `<span style="color: #10b981;">${cat._id}</span>: <span style="color: #f59e0b; font-weight: 600;">${cat.count}</span>`
      ).join(' <span style="color: var(--text-muted);">•</span> ');
      stats.innerHTML = `<span style="color: #3b82f6; font-weight: 600;">Total: ${total}</span> <span style="color: var(--text-muted);">•</span> ${categoryText}`;
    }
  }

  async function applyActivityFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    const actionFilter = document.getElementById('actionFilter');
    const clearBtn = document.getElementById('clearActivityFilter');
    
    const category = categoryFilter.value;
    const action = actionFilter.value;
    
    if (category || action) {
      clearBtn.style.display = 'inline-block';
    } else {
      clearBtn.style.display = 'none';
    }
    
    await loadActivity(category, action);
  }

  function clearActivityFilters() {
    const categoryFilter = document.getElementById('categoryFilter');
    const actionFilter = document.getElementById('actionFilter');
    const clearBtn = document.getElementById('clearActivityFilter');
    
    categoryFilter.value = '';
    actionFilter.value = '';
    actionFilter.style.display = 'none';
    clearBtn.style.display = 'none';
    
    if (currentUsername) {
      loadActivity();
    }
  }

  function closeModal() {
    document.getElementById('activityModal').style.display = 'none';
  }

  document.getElementById('activityModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('activityModal')) {
      closeModal();
    }
  });

  document.getElementById('suspendModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('suspendModal')) {
      closeSuspendModal();
    }
  });

  async function handleLogout() {
    const confirmed = confirm('Are you sure you want to logout from this account?');
    if (confirmed) {
      await logout();
    }
  }

  async function logout() {
    try {
      const res = await fetch('/api/auth/logout', { 
        method: 'POST',
        credentials: 'include',
        headers: {
          'Accept': 'application/json'
        }
      });
      if (res.ok) {
        window.location.href = '/';
      } else {
        console.error('Logout failed');
        alert('Logout failed');
      }
    } catch (err) {
      console.error(err);
      alert('An error occurred during logout');
    }
  }

  // Theme initialization
  (function() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    window.addEventListener('load', function() {
      const btn = document.getElementById('themeToggle');
      if (btn && savedTheme === 'dark') {
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
      } else if (btn) {
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
      }
    });
  })();
</script>

<%- include('partials/footer') %>
