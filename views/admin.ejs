<%- include('partials/header') %>

<nav
  style="
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--glass-border);
  "
>
  <div
    style="
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    "
  >
    <span>âš¡</span> NewsBite
    <span
      style="
        font-size: 0.75rem;
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        padding: 0.2rem 0.5rem;
        border-radius: 1rem;
        border: 1px solid rgba(59, 130, 246, 0.3);
      "
      >Admin</span
    >
  </div>
  <button
    onclick="handleLogout()"
    class="btn-primary"
    style="
      border: none;
      cursor: pointer;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-radius: 1rem;
    "
  >
    Logout
  </button>
</nav>

<div class="container" style="margin-top: 3rem">
  <header class="feed-header">
    <h1
      style="
        font-size: 2.5rem;
        background: linear-gradient(to right, #3b82f6, #10b981);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      "
    >
      Admin Dashboard
    </h1>
    <p style="color: var(--text-muted); font-size: 1.1rem">
      Manage users and view platform statistics
    </p>
  </header>

  <!-- Statistics Cards -->
  <div
    style="
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    "
  >
    <div
      class="glass-panel"
      data-filter-type="all"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('all')"
      onmouseover="this.style.background='rgba(255,255,255,0.08)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Total Users
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: var(--text-main)">
        <%= stats.total %>
      </p>
    </div>
    <div
      class="glass-panel"
      data-filter-type="active"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('active')"
      onmouseover="this.style.background='rgba(16,185,129,0.1)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Active Users
      </h3>
      <p
        style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color)"
      >
        <%= stats.active %>
      </p>
    </div>
    <div
      class="glass-panel"
      data-filter-type="suspended"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('suspended')"
      onmouseover="this.style.background='rgba(239,68,68,0.1)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Suspended
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: #ef4444">
        <%= stats.suspended %>
      </p>
    </div>
    <div
      class="glass-panel"
      data-filter-type="admin"
      style="
        padding: 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      "
      onclick="filterUsers('admin')"
      onmouseover="this.style.background='rgba(59,130,246,0.1)'"
      onmouseout="this.style.background='rgba(255,255,255,0.05)'"
    >
      <h3
        style="
          color: var(--text-muted);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        "
      >
        Admins
      </h3>
      <p style="font-size: 2.5rem; font-weight: 700; color: #3b82f6">
        <%= stats.admins %>
      </p>
    </div>
  </div>

  <!-- Users Table -->
  <div
    class="glass-panel"
    style="padding: 2rem; border-radius: 1rem; margin-bottom: 4rem"
  >
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      "
    >
      <h2 style="font-size: 1.5rem; font-weight: 700">
        User Management
        <span
          id="filterBadge"
          style="
            display: none;
            margin-left: 1rem;
            font-size: 0.9rem;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.3);
          "
        ></span>
      </h2>
      <button
        id="clearFilter"
        style="
          display: none;
          padding: 0.5rem 1rem;
          background: rgba(239, 68, 68, 0.2);
          color: #ef4444;
          border: 1px solid rgba(239, 68, 68, 0.3);
          border-radius: 0.5rem;
          cursor: pointer;
          font-size: 0.9rem;
        "
        onclick="clearFilter()"
      >
        Clear Filter
      </button>
    </div>
    <div style="overflow-x: auto">
      <table style="width: 100%; border-collapse: collapse">
        <thead>
          <tr style="border-bottom: 1px solid var(--glass-border)">
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Username
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Role
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Status
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Joined
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Last Login
            </th>
            <th
              style="
                padding: 1rem;
                text-align: left;
                color: var(--text-muted);
                font-weight: 600;
              "
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(u => { %>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05)">
            <td
              style="padding: 1rem; color: var(--text-main); font-weight: 500"
            >
              <%= u.username %>
            </td>
            <td style="padding: 1rem">
              <span
                style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; <%= u.role === 'admin' ? 'background: rgba(59, 130, 246, 0.2); color: #3b82f6;' : 'background: rgba(156, 163, 175, 0.2); color: var(--text-muted);' %>"
              >
                <%= u.role %>
              </span>
            </td>
            <td style="padding: 1rem">
              <span
                style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; <%= u.status === 'active' ? 'background: rgba(16, 185, 129, 0.2); color: var(--primary-color);' : u.status === 'suspended' ? 'background: rgba(239, 68, 68, 0.2); color: #ef4444;' : 'background: rgba(156, 163, 175, 0.2); color: var(--text-muted);' %>"
              >
                <%= u.status %>
              </span>
            </td>
            <td
              style="
                padding: 1rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              "
            >
              <%= new Date(u.createdAt).toLocaleDateString() %>
            </td>
            <td
              style="
                padding: 1rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              "
            >
              <%= u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() :
              'Never' %>
            </td>
            <td style="padding: 1rem">
              <div style="display: flex; gap: 0.5rem">
                <button
                  onclick="viewActivity('<%= u.username %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #3b82f6;
                    color: #3b82f6;
                  "
                >
                  Activity
                </button>
                <% if (u.status === 'active' && u.role !== 'admin') { %>
                <button
                  onclick="suspendUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #ef4444;
                    color: #ef4444;
                  "
                >
                  Suspend
                </button>
                <% } else if (u.status === 'suspended') { %>
                <button
                  onclick="unsuspendUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: var(--primary-color);
                    color: var(--primary-color);
                  "
                >
                  Unsuspend
                </button>
                <% } %> <% if (u.role !== 'admin' && u._id.toString() !==
                user.userId) { %>
                <button
                  onclick="deleteUser('<%= u._id %>')"
                  class="btn-outline"
                  style="
                    padding: 0.25rem 0.75rem;
                    font-size: 0.75rem;
                    border-color: #ef4444;
                    color: #ef4444;
                  "
                >
                  Delete
                </button>
                <% } %>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Registration Stats -->
  <div
    class="glass-panel"
    style="padding: 2rem; border-radius: 1rem; margin-bottom: 3rem"
  >
    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem">
      Registration Trends (Last 30 Days)
    </h2>
    <div style="height: 300px; width: 100%">
      <canvas id="registrationChart"></canvas>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</div>

<!-- Activity Modal -->
<div
  id="activityModal"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 100;
    align-items: center;
    justify-content: center;
  "
>
  <div
    class="glass-panel"
    style="
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      padding: 2rem;
      border-radius: 1.5rem;
    "
  >
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      "
    >
      <h3 id="modalTitle" style="font-size: 1.5rem; font-weight: 700">
        User Activity
      </h3>
      <button
        onclick="closeModal()"
        style="
          background: none;
          border: none;
          color: var(--text-muted);
          font-size: 1.5rem;
          cursor: pointer;
        "
      >
        &times;
      </button>
    </div>
    <div id="activityContent" style="overflow-y: auto; flex: 1">Loading...</div>
  </div>
</div>

<script>
  // Filter users by status or role
  function filterUsers(type) {
    const tableBody = document.querySelector('table tbody');
    const rows = tableBody.querySelectorAll('tr');
    let visibleCount = 0;
    const filterBadge = document.getElementById('filterBadge');
    const clearBtn = document.getElementById('clearFilter');
    const statCards = document.querySelectorAll('.glass-panel');

    // Remove active state from all cards
    document.querySelectorAll('[data-filter-type]').forEach(card => {
      card.style.opacity = '1';
      card.style.transform = 'scale(1)';
      card.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    });

    // Add active state to clicked card
    const activeCard = document.querySelector(`[data-filter-type="${type}"]`);
    if (activeCard) {
      activeCard.style.opacity = '1';
      activeCard.style.transform = 'scale(1.02)';
      activeCard.style.borderColor = '#3b82f6';
      activeCard.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
    }

    rows.forEach(row => {
      const statusCell = row.cells[2]; // Status column
      const roleCell = row.cells[1]; // Role column
      const status = statusCell.textContent.trim();
      const role = roleCell.textContent.trim();

      let shouldShow = false;
      let filterLabel = '';

      if (type === 'all') {
        shouldShow = true;
        filterLabel = '';
      } else if (type === 'active') {
        shouldShow = status === 'active';
        filterLabel = 'Active Users';
      } else if (type === 'suspended') {
        shouldShow = status === 'suspended';
        filterLabel = 'Suspended Users';
      } else if (type === 'admin') {
        shouldShow = role === 'admin';
        filterLabel = 'Admin Users';
      }

      row.style.display = shouldShow ? '' : 'none';
      if (shouldShow) visibleCount++;
    });

    // Update badge
    if (filterLabel) {
      filterBadge.textContent = filterLabel;
      filterBadge.style.display = 'inline-block';
      clearBtn.style.display = 'inline-block';
    } else {
      filterBadge.style.display = 'none';
      clearBtn.style.display = 'none';
    }

    // Show a message if no users match
    if (visibleCount === 0) {
      const emptyRow = document.createElement('tr');
      emptyRow.style.cssText = 'text-align: center;';
      emptyRow.innerHTML = `<td colspan="6" style="padding: 2rem; color: var(--text-muted);">No users found for this filter</td>`;
      tableBody.appendChild(emptyRow);
      setTimeout(() => emptyRow.remove(), 3000);
    }
  }

  // Clear filter and show all users
  function clearFilter() {
    const tableBody = document.querySelector('table tbody');
    const rows = tableBody.querySelectorAll('tr');

    rows.forEach(row => {
      row.style.display = '';
    });

    // Reset badge
    document.getElementById('filterBadge').style.display = 'none';
    document.getElementById('clearFilter').style.display = 'none';

    // Remove active state from all cards
    document.querySelectorAll('[data-filter-type]').forEach(card => {
      card.style.opacity = '1';
      card.style.transform = 'scale(1)';
      card.style.borderColor = 'rgba(255, 255, 255, 0.1)';
      card.style.boxShadow = 'none';
    });
  }

  // Initialize Chart.js
  document.addEventListener('DOMContentLoaded', () => {
    const registrationStats = <%- JSON.stringify(registrationStats || []) %>;

    if (registrationStats.length > 0) {
      const ctx = document.getElementById('registrationChart').getContext('2d');

      // Create gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
      gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: registrationStats.map(s => {
            const date = new Date(s.date);
            return `${date.getDate()}/${date.getMonth() + 1}`;
          }),
          datasets: [{
            label: 'New Users',
            data: registrationStats.map(s => s.count),
            borderColor: '#3b82f6',
            backgroundColor: gradient,
            borderWidth: 2,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: '#9ca3af', stepSize: 1 }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#9ca3af' }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    }
  });

  async function suspendUser(userId) {
    if (!confirm("Are you sure you want to suspend this user?")) return;

    try {
      const res = await fetch(`/api/admin/users/${userId}/suspend`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        alert("User suspended successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to suspend user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  async function unsuspendUser(userId) {
    try {
      const res = await fetch(`/api/admin/users/${userId}/unsuspend`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        alert("User unsuspended successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to unsuspend user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  async function deleteUser(userId) {
    if (
      !confirm(
        "Are you sure you want to delete this user? This action cannot be undone."
      )
    )
      return;

    try {
      const res = await fetch(`/api/admin/users/${userId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ confirm: true })
      });

      if (res.ok) {
        alert("User deleted successfully");
        location.reload();
      } else {
        const data = await res.json();
        alert(data.message || "Failed to delete user");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred");
    }
  }

  function formatMeta(meta) {
    if (!meta || Object.keys(meta).length === 0) return '';

    let html = '<div style="display: grid; gap: 0.25rem; margin-top: 0.5rem; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 0.5rem;">';

    for (const [key, value] of Object.entries(meta)) {
      if (key === 'ip' || key === 'userAgent') continue;

      let displayValue = value;
      let displayKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');

      if (key === 'targetUsername') displayKey = 'Target User';
      if (key === 'targetId') displayKey = 'Target ID';

      html += `
        <div style="display: flex; gap: 0.5rem; font-size: 0.85rem;">
          <span style="color: var(--text-muted); min-width: 80px;">${displayKey}:</span>
          <span style="color: var(--text-main); word-break: break-all;">${displayValue}</span>
        </div>
      `;
    }

    html += '</div>';
    return html;
  }

  async function viewActivity(username) {
    const modal = document.getElementById('activityModal');
    const content = document.getElementById('activityContent');
    const title = document.getElementById('modalTitle');

    title.textContent = `Activity: ${username}`;
    content.innerHTML = '<div style="display: flex; justify-content: center; padding: 2rem;"><div class="spinner"></div></div>';
    modal.style.display = 'flex';

    try {
      const res = await fetch(`/api/admin/users/${username}/activity`);
      const data = await res.json();

      if (res.ok) {
        if (data.activities.length === 0) {
          content.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No activity recorded.</p>';
          return;
        }

        content.innerHTML = data.activities.map(act => `
          <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border); margin-bottom: 0.5rem; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
              <span style="font-weight: 600; color: var(--primary-color); font-family: monospace; background: rgba(59, 130, 246, 0.1); padding: 0.1rem 0.4rem; border-radius: 0.25rem;">${act.action}</span>
              <span style="font-size: 0.75rem; color: var(--text-muted);">${new Date(act.createdAt).toLocaleString()}</span>
            </div>
            ${formatMeta(act.meta)}
          </div>
        `).join('');
      } else {
        content.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${data.message}</p>`;
      }
    } catch (err) {
      console.error(err);
      content.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load activity.</p>';
    }
  }

  function closeModal() {
    document.getElementById('activityModal').style.display = 'none';
  }

  document.getElementById('activityModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('activityModal')) {
      closeModal();
    }
  });

  async function handleLogout() {
    const confirmed = confirm('Are you sure you want to logout from this account?');
    if (confirmed) {
      await logout();
    }
  }

  async function logout() {
    try {
      const res = await fetch('/api/auth/logout', { method: 'POST' });
      if (res.ok) {
        window.location.href = '/';
      } else {
        console.error('Logout failed');
        alert('Logout failed');
      }
    } catch (err) {
      console.error(err);
      alert('An error occurred during logout');
    }
  }
</script>

<%- include('partials/footer') %>
