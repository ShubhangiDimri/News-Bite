<%- include('partials/header') %> <%- include('partials/navbar') %>

<div class="container">
  <div class="profile-header" style="margin-top: 3rem">
    <div
      class="profile-avatar"
      id="profileAvatar"
      style="cursor: pointer; overflow: hidden; position: relative"
    >
      <% if (user.profileImage) { %>
      <img
        id="avatarImage"
        src="<%= user.profileImage %>"
        alt="Profile"
        style="width: 100%; height: 100%; object-fit: cover"
      />
      <% } else { %> <%= user.username.charAt(0).toUpperCase() %> <% } %>
      <div
        class="avatar-overlay"
        style="
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          background: rgba(0, 0, 0, 0.5);
          color: white;
          font-size: 0.8rem;
          padding: 2px 0;
          display: none;
        "
      >
        Edit
      </div>
    </div>
    <input type="file" id="photoInput" accept="image/*" style="display: none" />

    <h1 class="profile-name"><%= user.username %></h1>
    <% if (user.bio_data) { %>
    <p class="profile-bio"><%= user.bio_data %></p>
    <% } else { %>
    <p class="profile-bio" style="color: var(--text-muted); font-style: italic">
      No bio yet. Add one below!
    </p>
    <% } %>

    <!-- Bio Edit Form -->
    <div
      class="bio-edit-section"
      style="max-width: 500px; margin: 1.5rem auto 0"
    >
      <form
        id="bioForm"
        style="display: flex; flex-direction: column; gap: 1rem"
      >
        <textarea
          name="bio"
          class="form-input"
          placeholder="Tell us about yourself..."
          rows="3"
          style="resize: vertical; min-height: 80px"
        >
<%= user.bio_data || '' %></textarea
        >
        <button
          type="submit"
          class="btn btn-primary"
          style="align-self: flex-end"
        >
          Save Bio
        </button>
      </form>
    </div>

    <!-- Activity Section -->
    <div style="margin-top: 2rem; width: 100%; max-width: 600px">
      <button
        id="showActivityBtn"
        class="btn btn-outline"
        style="width: auto; padding: 0.5rem 2rem"
      >
        Show Activity
      </button>

      <div
        id="activityContainer"
        style="display: none; margin-top: 1rem; text-align: left"
      >
        <h3 style="margin-bottom: 1rem">Recent Activity</h3>
        <div id="activityList">
          <!-- Activity items will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Section -->
  <div
    style="
      margin-top: 3rem;
      text-align: center;
      border-top: 1px solid var(--glass-border);
      padding-top: 2rem;
    "
  >
    <a
      href="/logout"
      class="btn btn-outline"
      style="color: var(--danger-color); border-color: var(--danger-color)"
      >Logout</a
    >
  </div>
</div>

<script>
  // Profile Photo Upload
  const avatar = document.getElementById("profileAvatar");
  const fileInput = document.getElementById("photoInput");

  if (avatar && fileInput) {
    avatar.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", async (e) => {
      if (!e.target.files || !e.target.files[0]) return;

      const formData = new FormData();
      formData.append("photo", e.target.files[0]);

      try {
        const res = await fetch("/api/user/upload-photo", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();

        if (res.ok) {
          // Update image
          const img = document.getElementById("avatarImage");
          if (img) {
            img.src = data.profileImage;
          } else {
            // If it was text before, replace with img
            avatar.innerHTML = `<img id="avatarImage" src="${data.profileImage}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">`;
          }
          alert("Profile photo updated!");
        } else {
          alert(data.message || "Error uploading photo");
        }
      } catch (err) {
        console.error(err);
        alert("Error uploading photo");
      }
    });
  }

  // Bio Form Submission
  document.getElementById("bioForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const bio_data = formData.get("bio");

    try {
      const res = await fetch("/api/user/profile", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bio_data }),
      });

      const result = await res.json();

      if (res.ok) {
        alert("Bio updated successfully!");
        const bioDisplay = document.querySelector(".profile-bio");
        if (bioDisplay) {
          if (bio_data) {
            bioDisplay.textContent = bio_data;
            bioDisplay.style.color = "var(--text-main)";
            bioDisplay.style.fontStyle = "normal";
          } else {
            bioDisplay.textContent = "No bio yet. Add one below!";
            bioDisplay.style.color = "var(--text-muted)";
            bioDisplay.style.fontStyle = "italic";
          }
        }
      } else {
        alert(result.message || "Failed to update bio");
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred while updating bio");
    }
  });

  // Activity Toggle
  const activityBtn = document.getElementById("showActivityBtn");
  const activityContainer = document.getElementById("activityContainer");
  const activityList = document.getElementById("activityList");

  if (activityBtn) {
    activityBtn.addEventListener("click", async () => {
      // Toggle visibility
      if (activityContainer.style.display === "block") {
        activityContainer.style.display = "none";
        activityBtn.textContent = "Show Activity";
        return;
      }

      activityContainer.style.display = "block";
      activityBtn.textContent = "Hide Activity";

      // Fetch if empty
      if (activityList.children.length === 0) {
        activityList.innerHTML =
          '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div></div>'; // Simple loader placeholder

        try {
          const res = await fetch("/api/user/activity");
          const data = await res.json();

          if (res.ok && data.activity) {
            if (data.activity.length === 0) {
              activityList.innerHTML =
                '<p style="color: var(--text-muted); text-align: center;">No recent activity.</p>';
              return;
            }

            activityList.innerHTML = data.activity
              .map((item) => {
                // Use createdAt (interaction time) if available, otherwise fallback to newsDate (published time)
                const dateObj = item.createdAt
                  ? new Date(item.createdAt)
                  : item.newsDate
                  ? new Date(item.newsDate)
                  : null;
                const dateStr = dateObj
                  ? dateObj.toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "short",
                      day: "numeric",
                    })
                  : "Unknown Date";

                let badges = "";
                if (item.likes > 0)
                  badges +=
                    '<span style="color: #ef4444; margin-right: 1rem;">â™¥ Liked</span>';
                if (item.bookmarked)
                  badges +=
                    '<span style="color: var(--primary-color); margin-right: 1rem;">ðŸ”– Bookmarked</span>';
                if (item.comments && item.comments.length > 0)
                  badges +=
                    '<span style="color: var(--text-muted);">ðŸ’¬ Commented</span>';

                return `
                <div class="glass-panel" style="padding: 1.5rem; margin-bottom: 1rem; border-radius: var(--radius); background: var(--glass-bg); border: 1px solid var(--glass-border);">
                  <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    ${dateStr}
                  </div>
                  <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem;">
                    <a href="${item.newsUrl}" target="_blank" style="color: var(--text-main); text-decoration: none;">
                      ${item.newsTitle}
                    </a>
                  </h3>
                  <div style="display: flex; flex-wrap: wrap; font-size: 0.9rem;">
                    ${badges}
                  </div>
                </div>
              `;
              })
              .join("");
          } else {
            activityList.innerHTML =
              '<p style="text-align: center; color: var(--danger-color);">Error loading activity.</p>';
          }
        } catch (err) {
          console.error(err);
          activityList.innerHTML =
            '<p style="text-align: center; color: var(--danger-color);">Error loading activity.</p>';
        }
      }
    });
  }
</script>

<%- include('partials/footer') %>
